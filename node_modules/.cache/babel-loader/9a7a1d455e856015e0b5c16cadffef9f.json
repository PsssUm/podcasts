{"ast":null,"code":"var _classCallCheck = require(\"/Users/spbiphones/Dropbox/projects/web projects/podcasts/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/Users/spbiphones/Dropbox/projects/web projects/podcasts/node_modules/@babel/runtime/helpers/createClass\");\n\nvar fs = require('fs');\n\nvar versions = ['2.5', 'x', '2', '1'],\n    layers = ['x', '3', '2', '1'],\n    bitRates = {\n  V1L1: [0, 32, 64, 96, 128, 160, 192, 224, 256, 288, 320, 352, 384, 416, 448],\n  V1L2: [0, 32, 48, 56, 64, 80, 96, 112, 128, 160, 192, 224, 256, 320, 384],\n  V1L3: [0, 32, 40, 48, 56, 64, 80, 96, 112, 128, 160, 192, 224, 256, 320],\n  V2L1: [0, 32, 48, 56, 64, 80, 96, 112, 128, 144, 160, 176, 192, 224, 256],\n  V2L2: [0, 8, 16, 24, 32, 40, 48, 56, 64, 80, 96, 112, 128, 144, 160],\n  V2L3: [0, 8, 16, 24, 32, 40, 48, 56, 64, 80, 96, 112, 128, 144, 160],\n  V1Lx: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n  V2Lx: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n  VxLx: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n  VxL1: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n  VxL2: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n  VxL3: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]\n},\n    sampleRates = {\n  'x': [0, 0, 0],\n  '1': [44100, 48000, 32000],\n  '2': [22050, 24000, 16000],\n  '2.5': [11025, 12000, 8000]\n},\n    samples = {\n  '1': {\n    'x': 0,\n    '1': 384,\n    '2': 1152,\n    '3': 1152\n  },\n  '2': {\n    'x': 0,\n    '1': 384,\n    '2': 1152,\n    '3': 576\n  },\n  'x': {\n    'x': 0,\n    '1': 0,\n    '2': 0,\n    '3': 0\n  }\n};\n\nvar Duration =\n/*#__PURE__*/\nfunction () {\n  \"use strict\";\n\n  function Duration() {\n    _classCallCheck(this, Duration);\n  }\n\n  _createClass(Duration, null, [{\n    key: \"getDuration\",\n\n    /**\r\n     * Returns the duration of an mp3 file.\r\n     * \r\n     * @param {String} filename \r\n     * @returns {{duration:Number, offset:Number}}\r\n     */\n    value: function getDuration(filename) {\n      var fd = fs.openSync(filename, 'r'),\n          buffer = Buffer.alloc(100),\n          block = fs.readSync(fd, buffer, 0, 100, 0),\n          stat = fs.statSync(filename),\n          duration = 0,\n          _offset = 0;\n\n      try {\n        calculateDuration: {\n          if (block < 100) {\n            break calculateDuration;\n          }\n\n          var offset = _offset = this.skipID3v2Tag(buffer);\n\n          while (offset < stat.size) {\n            block = fs.readSync(fd, buffer, 0, 10, offset);\n\n            if (block < 10) {\n              break calculateDuration;\n            } else if (buffer[0] == 255 && (buffer[1] & 224) == 224) {\n              var info = this.parseFrameHeader(buffer);\n\n              if (!info.frameSize || isNaN(info.frameSize) || !info.samples || isNaN(info.samples)) {\n                offset += 1;\n              } else {\n                offset += info.frameSize;\n                duration += info.samples / info.sampleRate;\n              }\n            } else if (buffer[0] === 84 && buffer[1] === 65 && buffer[2] === 71) {\n              // 'TAG'\n              offset += 128;\n            } else {\n              offset += 1;\n            }\n          }\n        }\n      } catch (e) {\n        console.error(e);\n      } finally {\n        fs.closeSync(fd);\n      }\n\n      return {\n        duration: parseFloat(duration.toFixed(2)),\n        offset: _offset\n      };\n    }\n    /**\r\n     * http://id3.org/ID3v2Easy\r\n     * \r\n     * @param {Buffer} buffer \r\n     * @returns {Number}\r\n     */\n\n  }, {\n    key: \"skipID3v2Tag\",\n    value: function skipID3v2Tag(buffer) {\n      if (buffer[0] == 73 && buffer[1] == 68 && buffer[2] == 51) {\n        // ID3\n        var z0 = buffer[6],\n            z1 = buffer[7],\n            z2 = buffer[8],\n            z3 = buffer[9];\n\n        if ((z0 & 128) == 0 && (z1 & 128) == 0 && (z2 & 128) == 0 && (z3 & 128) == 0) {\n          var headerSize = 10,\n              tagSize = (z0 & 127) * 2097152 + (z1 & 127) * 16384 + (z2 & 128) * 128 + (z3 & 128),\n              footerSize = buffer[5] & 16 ? 10 : 0;\n          return headerSize + tagSize + footerSize;\n        }\n      }\n\n      return 0;\n    }\n    /**\r\n     * Parses the frame header of a buffer.\r\n     * \r\n     * @param {Buffer} buffer \r\n     * @returns {sampleRate:Number, samples:Object, frameSize:Number}\r\n     */\n\n  }, {\n    key: \"parseFrameHeader\",\n    value: function parseFrameHeader(buffer) {\n      var b1 = buffer[1],\n          b2 = buffer[2],\n          versionBits = (b1 & 24) >> 3,\n          version = versions[versionBits],\n          simpleVersion = version == '2.5' ? 2 : version,\n          layerBits = (b1 & 6) >> 1,\n          layer = layers[layerBits],\n          bitRateKey = \"V\".concat(simpleVersion, \"L\").concat(layer),\n          bitRateIdx = (b2 & 240) >> 4,\n          bitRate = bitRates[bitRateKey][bitRateIdx] || 0,\n          sampleRateIdx = (b2 & 12) >> 2,\n          sampleRate = sampleRates[version][sampleRateIdx] || 0,\n          $samples = samples[simpleVersion][layer],\n          paddingBit = (b2 & 2) >> 1,\n          frameSize = this.getFrameSize(layer, bitRate, sampleRate, paddingBit);\n      return {\n        sampleRate: sampleRate,\n        samples: $samples,\n        frameSize: frameSize\n      };\n    }\n    /**\r\n     * Returns the frame size.\r\n     * \r\n     * @param {String} layer \r\n     * @param {Number} bitRate \r\n     * @param {Number} sampleRate \r\n     * @param {Number} paddingBit \r\n     * @returns {Number}\r\n     */\n\n  }, {\n    key: \"getFrameSize\",\n    value: function getFrameSize(layer, bitRate, sampleRate, paddingBit) {\n      if (layer == 1) {\n        return parseInt((12 * bitRate * 1000 / sampleRate + paddingBit) * 4);\n      } else {\n        return parseInt(144 * bitRate * 1000 / sampleRate + paddingBit);\n      }\n    }\n  }]);\n\n  return Duration;\n}();\n\nmodule.exports = Duration;","map":{"version":3,"sources":["/Users/spbiphones/Dropbox/projects/web projects/podcasts/node_modules/mp3-cutter/lib/duration.js"],"names":["fs","require","versions","layers","bitRates","V1L1","V1L2","V1L3","V2L1","V2L2","V2L3","V1Lx","V2Lx","VxLx","VxL1","VxL2","VxL3","sampleRates","samples","Duration","filename","fd","openSync","buffer","Buffer","alloc","block","readSync","stat","statSync","duration","_offset","calculateDuration","offset","skipID3v2Tag","size","info","parseFrameHeader","frameSize","isNaN","sampleRate","e","console","error","closeSync","parseFloat","toFixed","z0","z1","z2","z3","headerSize","tagSize","footerSize","b1","b2","versionBits","version","simpleVersion","layerBits","layer","bitRateKey","bitRateIdx","bitRate","sampleRateIdx","$samples","paddingBit","getFrameSize","parseInt","module","exports"],"mappings":"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","sourcesContent":["const fs = require('fs');\r\n\r\nconst versions = ['2.5', 'x', '2', '1'],\r\n      layers = ['x', '3', '2', '1'],\r\n      bitRates = {\r\n        V1L1: [0,32,64,96,128,160,192,224,256,288,320,352,384,416,448],\r\n        V1L2: [0,32,48,56, 64, 80, 96,112,128,160,192,224,256,320,384],\r\n        V1L3: [0,32,40,48, 56, 64, 80, 96,112,128,160,192,224,256,320],\r\n        V2L1: [0,32,48,56, 64, 80, 96,112,128,144,160,176,192,224,256],\r\n        V2L2: [0, 8,16,24, 32, 40, 48, 56, 64, 80, 96,112,128,144,160],\r\n        V2L3: [0, 8,16,24, 32, 40, 48, 56, 64, 80, 96,112,128,144,160],\r\n        V1Lx: [0, 0, 0, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],\r\n        V2Lx: [0, 0, 0, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],\r\n        VxLx: [0, 0, 0, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],\r\n        VxL1: [0, 0, 0, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],\r\n        VxL2: [0, 0, 0, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0],\r\n        VxL3: [0, 0, 0, 0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0]\r\n      },\r\n      sampleRates = {\r\n        'x':   [    0,    0,    0],\r\n        '1'  : [44100,48000,32000],\r\n        '2'  : [22050,24000,16000],\r\n        '2.5': [11025,12000, 8000]\r\n      },\r\n      samples = {\r\n        '1': {\r\n            'x':   0,\r\n            '1': 384,\r\n            '2':1152,\r\n            '3':1152\r\n        },\r\n        '2': {\r\n            'x':   0,\r\n            '1': 384,\r\n            '2':1152,\r\n            '3': 576\r\n        },\r\n        'x': {\r\n            'x':0,\r\n            '1':0,\r\n            '2':0,\r\n            '3':0\r\n        }\r\n      };\r\n\r\nclass Duration {\r\n    /**\r\n     * Returns the duration of an mp3 file.\r\n     * \r\n     * @param {String} filename \r\n     * @returns {{duration:Number, offset:Number}}\r\n     */\r\n    static getDuration(filename) {\r\n        var fd = fs.openSync(filename, 'r'),\r\n            buffer = Buffer.alloc(100),\r\n            block = fs.readSync(fd, buffer, 0, 100, 0),\r\n            stat = fs.statSync(filename),\r\n            duration = 0,\r\n            _offset = 0;\r\n\r\n        try {\r\n            calculateDuration: {\r\n                if(block < 100) {\r\n                    break calculateDuration;\r\n                }\r\n\r\n                var offset = _offset = this.skipID3v2Tag(buffer);\r\n                while(offset < stat.size) {\r\n                    block = fs.readSync(fd, buffer, 0, 10, offset);\r\n          \r\n                    if(block < 10) {\r\n                        break calculateDuration;\r\n                    } else if(buffer[0] == 255 && (buffer[1] & 224) == 224) {\r\n                        var info = this.parseFrameHeader(buffer);\r\n            \r\n                        if(!info.frameSize || isNaN(info.frameSize) || !info.samples || isNaN(info.samples)) {\r\n                            offset += 1;\r\n                        } else {\r\n                            offset += info.frameSize;\r\n                            duration += (info.samples / info.sampleRate);\r\n                        }\r\n                    } else if (buffer[0] === 84 && buffer[1] === 65 && buffer[2] === 71) { // 'TAG'\r\n                        offset += 128;\r\n                    } else {\r\n                        offset += 1;\r\n                    }\r\n                  }\r\n            }\r\n        } catch(e) {\r\n            console.error(e);\r\n        } finally {\r\n            fs.closeSync(fd);\r\n        }\r\n\r\n        return {duration:parseFloat(duration.toFixed(2)), offset:_offset};            \r\n    }\r\n\r\n    /**\r\n     * http://id3.org/ID3v2Easy\r\n     * \r\n     * @param {Buffer} buffer \r\n     * @returns {Number}\r\n     */\r\n    static skipID3v2Tag(buffer) {\r\n      if(buffer[0] == 73 && buffer[1] == 68 && buffer[2] == 51) { // ID3\r\n        var z0 = buffer[6],\r\n            z1 = buffer[7],\r\n            z2 = buffer[8],\r\n            z3 = buffer[9];\r\n\r\n        if((z0 & 128) == 0 && (z1 & 128) == 0 && (z2 & 128) == 0 && (z3 & 128) == 0) {\r\n            var headerSize = 10,\r\n                tagSize = ((z0 & 127) * 2097152) + ((z1 & 127) * 16384) + ((z2 & 128) * 128) + (z3 & 128),\r\n                footerSize = (buffer[5] & 16) ? 10 : 0;\r\n            return headerSize + tagSize + footerSize;\r\n        }\r\n      }\r\n\r\n      return 0;      \r\n    }\r\n\r\n    /**\r\n     * Parses the frame header of a buffer.\r\n     * \r\n     * @param {Buffer} buffer \r\n     * @returns {sampleRate:Number, samples:Object, frameSize:Number}\r\n     */\r\n    static parseFrameHeader(buffer) {\r\n      var b1 = buffer[1],\r\n          b2 = buffer[2],\r\n          versionBits = (b1 & 24) >> 3,\r\n          version = versions[versionBits],\r\n          simpleVersion = (version == '2.5') ? 2 : version,\r\n          layerBits = (b1 & 6) >> 1,\r\n          layer = layers[layerBits],\r\n          bitRateKey = `V${simpleVersion}L${layer}`,\r\n          bitRateIdx = (b2 & 240) >> 4,\r\n          bitRate = bitRates[bitRateKey][bitRateIdx] || 0,\r\n          sampleRateIdx = (b2 & 12) >> 2,\r\n          sampleRate = sampleRates[version][sampleRateIdx] || 0,\r\n          $samples = samples[simpleVersion][layer],\r\n          paddingBit = (b2 & 2) >> 1,\r\n          frameSize = this.getFrameSize(layer, bitRate, sampleRate, paddingBit);\r\n          \r\n      return {\r\n          sampleRate,\r\n          samples: $samples,\r\n          frameSize\r\n      };\r\n    }\r\n\r\n    /**\r\n     * Returns the frame size.\r\n     * \r\n     * @param {String} layer \r\n     * @param {Number} bitRate \r\n     * @param {Number} sampleRate \r\n     * @param {Number} paddingBit \r\n     * @returns {Number}\r\n     */\r\n    static getFrameSize(layer, bitRate, sampleRate, paddingBit) {\r\n      if(layer == 1) {\r\n        return parseInt(((12 * bitRate * 1000 / sampleRate) + paddingBit) * 4);\r\n      } else {\r\n        return parseInt(((144 * bitRate * 1000) / sampleRate) + paddingBit);\r\n      }\r\n    }\r\n}\r\n\r\nmodule.exports = Duration;"]},"metadata":{},"sourceType":"script"}